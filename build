#!/bin/sh

set -e -x

# ===================================================
# Kernel Setup
# ===================================================
KERNEL_SOURCE="https://github.com/rdbckp/kernel"
KERNEL_BRANCH="main"
KERNEL_DEFCONFIG="a02_defconfig"

# ===================================================
# Toolchain Setup
# ===================================================
CLANG_URL="https://github.com/rdbckp/clang.git"
CLANG_BRANCH="main"
GCC_URL="https://github.com/rdbckp/gcc.git"
GCC_BRANCH="main"

# ===================================================
# Downloading Toolchain
# ===================================================
[ ! -d clang ] && git clone --depth=1 "${CLANG_URL}" -b "${CLANG_BRANCH}" ./clang
[ ! -d gcc ] && git clone --depth=1 "${GCC_URL}" -b "${GCC_BRANCH}" ./gcc

# ===================================================
# Folder and Path Setup
# ===================================================
WORK="${HOME}/work"
KERNEL="myKernel"
KERNEL_SRC="${WORK}/${KERNEL}"
mkdir -p "${WORK}"
cd "${WORK}" || exit 1
PATH="${WORK}/clang/bin:${WORK}/gcc/bin:/bin"
[ ! -d "${KERNEL}" ] && git clone --depth=1 "${KERNEL_SOURCE}" -b "${KERNEL_BRANCH}" "${KERNEL}"

# ===================================================
# Compiling
# ===================================================
cd "${KERNEL_SRC}" || exit 1
make O=out KCFLAGS="-w -ffreestanding" ARCH=arm CROSS_COMPILE=arm-linux-androideabi- CC=clang HOSTCC=gcc LD=ld.lld LDFLAGS="-lgcc -L${PWD}/toolchain/gcc/lib/gcc/arm-linux-androideabi/4.9.x" a02_defconfig
make O=out KCFLAGS="-w -ffreestanding" ARCH=arm CROSS_COMPILE=arm-linux-androideabi- CC=clang HOSTCC=gcc LD=ld.lld LDFLAGS="-lgcc -L${PWD}/toolchain/gcc/lib/gcc/arm-linux-androideabi/4.9.x" -j$(nproc) vmlinux
make O=out KCFLAGS="-w -ffreestanding" ARCH=arm CROSS_COMPILE=arm-linux-androideabi- CC=clang HOSTCC=gcc LD=ld.lld LDFLAGS="-lgcc -L${PWD}/toolchain/gcc/lib/gcc/arm-linux-androideabi/4.9.x" -j$(nproc) zImage 2>&1 | tee build.log 
